#!/usr/bin/env bash

set -euo pipefail

# ------------------------------
# CONFIG
# ------------------------------
NOTES_ROOT="$HOME/Desktop/my-learning-notes"
DEFAULT_SECTION="in-progress"
DEFAULT_EDITOR="code"

# ------------------------------
# HELP
# ------------------------------
usage() {
cat <<EOF
Usage:
  note <topic> "<title>" [options]

Arguments:
  topic                 Technology or topic name (e.g. laravel, js, php)
  "title"               Note title (use quotes if it contains spaces)

Options:
  --youtube <url>       YouTube video link
  --channel <value>     YouTube channel in format:
                        "Channel Name|https://youtube.com/@channel"
  --next <url>          Link to the next lesson/video
  --project <path>      Local project folder path
  --db <name>           Database name (e.g. sqlite, mysql)
  --github <url>        GitHub repository URL
  --source <value>      Source code URL or local path
  --editor <command>    Editor command (default: code)
  --git                 Auto-commit note to git
  -h, --help            Show this help message

Behavior:
  • Notes are created in:
    $NOTES_ROOT/$DEFAULT_SECTION/<topic>/<slug>.md
  • Git auto-commit is OFF by default
  • Editor defaults to VS Code (code)
  • If --youtube is provided, the note title becomes a clickable link

Examples:
  note laravel "Laravel for beginners" \\
    --youtube https://youtu.be/eUNWzJUvkCA \\
    --channel "The Codeholic|https://www.youtube.com/@TheCodeholic" \\
    --git

  note bash "Bash scripting basics" --editor nano

EOF
}

# ------------------------------
# DEPENDENCIES
# ------------------------------
command -v git >/dev/null 2>&1 || {
  echo "❌ git is required"
  exit 1
}

# ------------------------------
# ARGUMENTS
# ------------------------------
[[ $# -lt 2 ]] && usage && exit 1

TOPIC="$1"
TITLE="$2"
shift 2

YOUTUBE=""
CHANNEL=""
NEXT=""
PROJECT=""
DB=""
GITHUB=""
SOURCE_CODE=""
EDITOR="$DEFAULT_EDITOR"
USE_GIT=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --youtube) YOUTUBE="$2"; shift 2 ;;
    --channel) CHANNEL="$2"; shift 2 ;;
    --next) NEXT="$2"; shift 2 ;;
    --project) PROJECT="$2"; shift 2 ;;
    --db) DB="$2"; shift 2 ;;
    --github) GITHUB="$2"; shift 2 ;;
    --source) SOURCE_CODE="$2"; shift 2 ;;
    --editor) EDITOR="$2"; shift 2 ;;
    --git) USE_GIT=true; shift ;;
    -h|--help) usage; exit 0 ;;
    *)
      echo "❌ Unknown option: $1"
      usage
      exit 1
      ;;
  esac
done

# ------------------------------
# VALIDATION
# ------------------------------
[[ -z "$TOPIC" || -z "$TITLE" ]] && {
  echo "❌ Topic and title are required"
  exit 1
}

command -v "$EDITOR" >/dev/null 2>&1 || {
  echo "❌ Editor not found: $EDITOR"
  exit 1
}

# ------------------------------
# SLUG
# ------------------------------
SLUG=$(echo "$TITLE" \
  | tr '[:upper:]' '[:lower:]' \
  | sed 's/[^a-z0-9 ]//g' \
  | tr ' ' '-')

NOTE_DIR="$NOTES_ROOT/$DEFAULT_SECTION/$TOPIC"
NOTE_FILE="$NOTE_DIR/$SLUG.md"

# ------------------------------
# FILESYSTEM
# ------------------------------
mkdir -p "$NOTE_DIR"

if [[ -f "$NOTE_FILE" ]]; then
  echo "❌ Note already exists:"
  echo "   $NOTE_FILE"
  exit 1
fi

# ------------------------------
# CHANNEL PARSING
# ------------------------------
CHANNEL_NAME=""
CHANNEL_URL=""

if [[ -n "$CHANNEL" ]]; then
  if [[ "$CHANNEL" == *"|"* ]]; then
    IFS='|' read -r CHANNEL_NAME CHANNEL_URL <<< "$CHANNEL"
  else
    echo "❌ --channel must be in format:"
    echo '   "Channel Name|https://youtube.com/@channel"'
    exit 1
  fi
fi

# ------------------------------
# MARKDOWN
# ------------------------------
{
if [[ -n "$YOUTUBE" ]]; then
  echo "# [$TITLE]($YOUTUBE)"
else
  echo "# $TITLE"
fi
echo

if [[ -n "$CHANNEL_NAME" && -n "$CHANNEL_URL" ]]; then
  echo "## [YouTube - $CHANNEL_NAME]($CHANNEL_URL)"
  echo
fi

echo "**PROJECT FOLDER:** ${PROJECT:-None}"
echo
echo "**DATABASE:** ${DB:-None}"
echo
echo "**GITHUB:** ${GITHUB:-None}"
echo
echo "**SOURCE CODE:** ${SOURCE_CODE:-None}"
echo

if [[ -n "$NEXT" ]]; then
  echo "**NEXT:** $NEXT"
fi
} > "$NOTE_FILE"

# ------------------------------
# OPEN EDITOR
# ------------------------------
"$EDITOR" "$NOTE_FILE"

# ------------------------------
# GIT AUTOCOMMIT (OPT-IN)
# ------------------------------
if [[ "$USE_GIT" == true ]]; then
  if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    git add "$NOTE_FILE"
    git commit -m "Add note: $TITLE" >/dev/null 2>&1 || true
  else
    echo "⚠️  Not a git repository, skipping commit"
  fi
fi

echo "✅ Note created:"
echo "   $NOTE_FILE"
